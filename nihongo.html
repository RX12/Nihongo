<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Kana Learner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .kana-char, .jp-font { /* Class for Japanese characters */
            font-family: 'Noto Sans JP', sans-serif;
        }
        .focusable:focus-visible {
            outline: 2px solid rgb(59 130 246); /* blue-500 */
            outline-offset: 2px;
        }
        .btn {
            @apply px-4 py-2 rounded-lg font-semibold transition-all duration-150 ease-in-out focusable;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800 shadow-md;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300 active:bg-gray-400 shadow-sm;
        }
        .btn-red {
            @apply bg-red-500 text-white hover:bg-red-600 active:bg-red-700 shadow-md;
        }
        .btn-warning {
            @apply bg-yellow-500 text-white hover:bg-yellow-600 active:bg-yellow-700 shadow-md;
        }
        .btn-green {
            @apply bg-green-500 text-white hover:bg-green-600 active:bg-green-700 shadow-md;
        }
        /* ADD THIS NEW CODE IN ITS PLACE */
        .kana-display {
            font-weight: 500; /* This is font-bold */
            margin-top: 1rem;
            margin-bottom: 1rem;
            font-size: 1rem; /* base font size to make the change obvious */
        }

        /* These "media queries" make the font responsive for different screen sizes */
        @media (min-width: 640px) { /* On small screens (sm) and up */
            .kana-display {
                font-size: 2.5rem;
                margin-top: 1.5rem;
                margin-bottom: 1.5rem;
            }
        }

        @media (min-width: 768px) { /* On medium screens (md) and up */
            .kana-display {
                font-size: 3.5rem;
            }
        }
        .feedback-correct {
            @apply text-green-600;
        }
        .feedback-incorrect {
            @apply text-red-600;
        }
        .kana-enter {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Progress Bar Styles */
        .progress-bar-container {
            @apply w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow;
        }
        .progress-bar {
            @apply bg-blue-600 h-4 rounded-full transition-all duration-300 ease-in-out text-xs flex items-center justify-center text-white;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4 antialiased">

    <div id="app-container" class="bg-white p-4 sm:p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-lg">

        <!-- Settings Screen -->
        <div id="settingsScreen">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-6 sm:mb-8 jp-font">Êó•Êú¨Ë™ûÂ≠¶Áøí <span class="text-sm text-gray-500 block">Kana Learner</span></h1>
            <div class="space-y-4 sm:space-y-6">
                <p class="text-gray-700 text-sm sm:text-base">Select the character sets you want to practice:</p>
                <div class="space-y-3">
                    <label class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-200 transition-colors cursor-pointer">
                        <input type="checkbox" id="useHiragana" class="form-checkbox h-5 w-5 text-blue-600 rounded focusable">
                        <span class="ml-3 text-gray-700 text-base sm:text-lg jp-font">„Å≤„Çâ„Åå„Å™ (Hiragana)</span>
                    </label>
                    <label class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-200 transition-colors cursor-pointer">
                        <input type="checkbox" id="useKatakana" class="form-checkbox h-5 w-5 text-blue-600 rounded focusable">
                        <span class="ml-3 text-gray-700 text-base sm:text-lg jp-font">„Ç´„Çø„Ç´„Éä (Katakana)</span>
                    </label>
                    <label class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-200 transition-colors cursor-pointer">
                        <input type="checkbox" id="useExtendedKatakana" class="form-checkbox h-5 w-5 text-blue-600 rounded focusable">
                        <span class="ml-3 text-gray-700 text-base sm:text-lg jp-font">Êã°Âºµ„Ç´„Çø„Ç´„Éä (Extended Katakana)</span>
                    </label>
                </div>
                 <p id="noSetSelectedError" class="text-red-500 text-sm mt-2 hidden">Please select at least one character set.</p>
                <button id="startButton" class="w-full btn btn-primary text-base sm:text-lg py-2 sm:py-3">Start Learning</button>
            </div>
        </div>

        <!-- Learning Screen (Hidden by default) -->
        <div id="learningScreen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-700 jp-font">Practice Mode</h2>
                <button id="backToSettingsButton" class="btn btn-secondary text-xs sm:text-sm">&larr; Change Sets</button>
            </div>

            <!-- Progress Bar -->
            <div class="mb-2 text-xs sm:text-sm text-gray-600 text-center" id="progressLabel">Mastered: 0 / 0</div>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
            </div>

            <div id="characterDisplay" class="kana-display text-center text-gray-800 kana-char"></div>

            <div class="mt-4 mb-4">
                <input type="text" id="romajiInput" placeholder="Type Romaji here..." class="w-full p-3 border border-gray-300 rounded-lg text-base sm:text-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent focusable" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                <button id="submitGuessButton" class="btn btn-green w-full text-sm sm:text-base">Submit Guess</button>
                <button id="showAnswerButton" class="btn btn-secondary w-full text-sm sm:text-base">Show Answer</button>
            </div>

            <div id="feedbackArea" class="text-center text-base sm:text-lg min-h-[2.5em] mb-4 font-semibold"></div>

            <div class="grid grid-cols-2 gap-2 text-center text-gray-600 mb-4 text-xs sm:text-sm">
                <span id="queueCountDisplay" class="p-1 sm:p-2 bg-gray-100 rounded-md">In Queue: 0</span>
                <span id="attemptCountDisplay" class="p-1 sm:p-2 bg-gray-100 rounded-md">Attempts: 0</span>
            </div>

            <button id="nextCharacterButton" class="w-full btn btn-primary py-2 sm:py-3 text-base sm:text-lg mb-3" disabled>Next Character &rarr;</button>
            <button id="resetSessionButton" class="w-full btn btn-warning py-2 text-sm sm:text-base">Reset Current Session</button>
            
            <div id="completionMessage" class="hidden text-center mt-6 sm:mt-8 p-4 sm:p-6 bg-green-50 rounded-lg">
                <h3 class="text-xl sm:text-2xl font-semibold text-green-700 jp-font">üéâÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ(Subarashii!)üéâ</h3>
                <p class="text-gray-700 mt-2 text-sm sm:text-base">You've completed the session!</p>
                <p id="finalScore" class="text-base sm:text-lg font-medium text-gray-800 mt-2"></p>
                <button id="restartButton" class="mt-4 btn btn-primary text-sm sm:text-base">Practice Again</button>
            </div>
        </div>
    </div>

    <script>
        // --- Character Data (same as before) ---
        const hiraganaChars = [
            { kana: "„ÅÇ", romaji: "a" }, { kana: "„ÅÑ", romaji: "i" }, { kana: "„ÅÜ", romaji: "u" }, { kana: "„Åà", romaji: "e" }, { kana: "„Åä", romaji: "o" },
            { kana: "„Åã", romaji: "ka" }, { kana: "„Åç", romaji: "ki" }, { kana: "„Åè", romaji: "ku" }, { kana: "„Åë", romaji: "ke" }, { kana: "„Åì", romaji: "ko" },
            { kana: "„Åï", romaji: "sa" }, { kana: "„Åó", romaji: "shi" }, { kana: "„Åô", romaji: "su" }, { kana: "„Åõ", romaji: "se" }, { kana: "„Åù", romaji: "so" },
            { kana: "„Åü", romaji: "ta" }, { kana: "„Å°", romaji: "chi" }, { kana: "„Å§", romaji: "tsu" }, { kana: "„Å¶", romaji: "te" }, { kana: "„Å®", romaji: "to" },
            { kana: "„Å™", romaji: "na" }, { kana: "„Å´", romaji: "ni" }, { kana: "„Å¨", romaji: "nu" }, { kana: "„Å≠", romaji: "ne" }, { kana: "„ÅÆ", romaji: "no" },
            { kana: "„ÅØ", romaji: "ha" }, { kana: "„Å≤", romaji: "hi" }, { kana: "„Åµ", romaji: "fu" }, { kana: "„Å∏", romaji: "he" }, { kana: "„Åª", romaji: "ho" },
            { kana: "„Åæ", romaji: "ma" }, { kana: "„Åø", romaji: "mi" }, { kana: "„ÇÄ", romaji: "mu" }, { kana: "„ÇÅ", romaji: "me" }, { kana: "„ÇÇ", romaji: "mo" },
            { kana: "„ÇÑ", romaji: "ya" }, { kana: "„ÇÜ", romaji: "yu" }, { kana: "„Çà", romaji: "yo" },
            { kana: "„Çâ", romaji: "ra" }, { kana: "„Çä", romaji: "ri" }, { kana: "„Çã", romaji: "ru" }, { kana: "„Çå", romaji: "re" }, { kana: "„Çç", romaji: "ro" },
            { kana: "„Çè", romaji: "wa" }, { kana: "„Çí", romaji: "o" }, { kana: "„Çì", romaji: "n" },
            { kana: "„Åå", romaji: "ga" }, { kana: "„Åé", romaji: "gi" }, { kana: "„Åê", romaji: "gu" }, { kana: "„Åí", romaji: "ge" }, { kana: "„Åî", romaji: "go" },
            { kana: "„Åñ", romaji: "za" }, { kana: "„Åò", romaji: "ji" }, { kana: "„Åö", romaji: "zu" }, { kana: "„Åú", romaji: "ze" }, { kana: "„Åû", romaji: "zo" },
            { kana: "„Å†", romaji: "da" }, { kana: "„Å¢", romaji: "ji" }, { kana: "„Å•", romaji: "zu" }, { kana: "„Åß", romaji: "de" }, { kana: "„Å©", romaji: "do" },
            { kana: "„Å∞", romaji: "ba" }, { kana: "„Å≥", romaji: "bi" }, { kana: "„Å∂", romaji: "bu" }, { kana: "„Åπ", romaji: "be" }, { kana: "„Åº", romaji: "bo" },
            { kana: "„Å±", romaji: "pa" }, { kana: "„Å¥", romaji: "pi" }, { kana: "„Å∑", romaji: "pu" }, { kana: "„Å∫", romaji: "pe" }, { kana: "„ÅΩ", romaji: "po" },
            { kana: "„Åç„ÇÉ", romaji: "kya" }, { kana: "„Åç„ÇÖ", romaji: "kyu" }, { kana: "„Åç„Çá", romaji: "kyo" },
            { kana: "„Åó„ÇÉ", romaji: "sha" }, { kana: "„Åó„ÇÖ", romaji: "shu" }, { kana: "„Åó„Çá", romaji: "sho" },
            { kana: "„Å°„ÇÉ", romaji: "cha" }, { kana: "„Å°„ÇÖ", romaji: "chu" }, { kana: "„Å°„Çá", romaji: "cho" },
            { kana: "„Å´„ÇÉ", romaji: "nya" }, { kana: "„Å´„ÇÖ", romaji: "nyu" }, { kana: "„Å´„Çá", romaji: "nyo" },
            { kana: "„Å≤„ÇÉ", romaji: "hya" }, { kana: "„Å≤„ÇÖ", romaji: "hyu" }, { kana: "„Å≤„Çá", romaji: "hyo" },
            { kana: "„Åø„ÇÉ", romaji: "mya" }, { kana: "„Åø„ÇÖ", romaji: "myu" }, { kana: "„Åø„Çá", romaji: "myo" },
            { kana: "„Çä„ÇÉ", romaji: "rya" }, { kana: "„Çä„ÇÖ", romaji: "ryu" }, { kana: "„Çä„Çá", romaji: "ryo" },
            { kana: "„Åé„ÇÉ", romaji: "gya" }, { kana: "„Åé„ÇÖ", romaji: "gyu" }, { kana: "„Åé„Çá", romaji: "gyo" },
            { kana: "„Åò„ÇÉ", romaji: "ja" }, { kana: "„Åò„ÇÖ", romaji: "ju" }, { kana: "„Åò„Çá", romaji: "jo" },
            { kana: "„Å¢„ÇÉ", romaji: "ja" }, { kana: "„Å¢„ÇÖ", romaji: "ju" }, { kana: "„Å¢„Çá", romaji: "jo" },
            { kana: "„Å≥„ÇÉ", romaji: "bya" }, { kana: "„Å≥„ÇÖ", romaji: "byu" }, { kana: "„Å≥„Çá", romaji: "byo" },
            { kana: "„Å¥„ÇÉ", romaji: "pya" }, { kana: "„Å¥„ÇÖ", romaji: "pyu" }, { kana: "„Å¥„Çá", romaji: "pyo" }
        ];
        const katakanaChars = [
            { kana: "„Ç¢", romaji: "a" }, { kana: "„Ç§", romaji: "i" }, { kana: "„Ç¶", romaji: "u" }, { kana: "„Ç®", romaji: "e" }, { kana: "„Ç™", romaji: "o" },
            { kana: "„Ç´", romaji: "ka" }, { kana: "„Ç≠", romaji: "ki" }, { kana: "„ÇØ", romaji: "ku" }, { kana: "„Ç±", romaji: "ke" }, { kana: "„Ç≥", romaji: "ko" },
            { kana: "„Çµ", romaji: "sa" }, { kana: "„Ç∑", romaji: "shi" }, { kana: "„Çπ", romaji: "su" }, { kana: "„Çª", romaji: "se" }, { kana: "„ÇΩ", romaji: "so" },
            { kana: "„Çø", romaji: "ta" }, { kana: "„ÉÅ", romaji: "chi" }, { kana: "„ÉÑ", romaji: "tsu" }, { kana: "„ÉÜ", romaji: "te" }, { kana: "„Éà", romaji: "to" },
            { kana: "„Éä", romaji: "na" }, { kana: "„Éã", romaji: "ni" }, { kana: "„Éå", romaji: "nu" }, { kana: "„Éç", romaji: "ne" }, { kana: "„Éé", romaji: "no" },
            { kana: "„Éè", romaji: "ha" }, { kana: "„Éí", romaji: "hi" }, { kana: "„Éï", romaji: "fu" }, { kana: "„Éò", romaji: "he" }, { kana: "„Éõ", romaji: "ho" },
            { kana: "„Éû", romaji: "ma" }, { kana: "„Éü", romaji: "mi" }, { kana: "„É†", romaji: "mu" }, { kana: "„É°", romaji: "me" }, { kana: "„É¢", romaji: "mo" },
            { kana: "„É§", romaji: "ya" }, { kana: "„É¶", romaji: "yu" }, { kana: "„É®", romaji: "yo" },
            { kana: "„É©", romaji: "ra" }, { kana: "„É™", romaji: "ri" }, { kana: "„É´", romaji: "ru" }, { kana: "„É¨", romaji: "re" }, { kana: "„É≠", romaji: "ro" },
            { kana: "„ÉØ", romaji: "wa" }, { kana: "„É≤", romaji: "o" }, { kana: "„É≥", romaji: "n" },
            { kana: "„Ç¨", romaji: "ga" }, { kana: "„ÇÆ", romaji: "gi" }, { kana: "„Ç∞", romaji: "gu" }, { kana: "„Ç≤", romaji: "ge" }, { kana: "„Ç¥", romaji: "go" },
            { kana: "„Ç∂", romaji: "za" }, { kana: "„Ç∏", romaji: "ji" }, { kana: "„Ç∫", romaji: "zu" }, { kana: "„Çº", romaji: "ze" }, { kana: "„Çæ", romaji: "zo" },
            { kana: "„ÉÄ", romaji: "da" }, { kana: "„ÉÇ", romaji: "ji" }, { kana: "„ÉÖ", romaji: "zu" }, { kana: "„Éá", romaji: "de" }, { kana: "„Éâ", romaji: "do" },
            { kana: "„Éê", romaji: "ba" }, { kana: "„Éì", romaji: "bi" }, { kana: "„Éñ", romaji: "bu" }, { kana: "„Éô", romaji: "be" }, { kana: "„Éú", romaji: "bo" },
            { kana: "„Éë", romaji: "pa" }, { kana: "„Éî", romaji: "pi" }, { kana: "„Éó", romaji: "pu" }, { kana: "„Éö", romaji: "pe" }, { kana: "„Éù", romaji: "po" },
            { kana: "„Ç≠„É£", romaji: "kya" }, { kana: "„Ç≠„É•", romaji: "kyu" }, { kana: "„Ç≠„Éß", romaji: "kyo" },
            { kana: "„Ç∑„É£", romaji: "sha" }, { kana: "„Ç∑„É•", romaji: "shu" }, { kana: "„Ç∑„Éß", romaji: "sho" },
            { kana: "„ÉÅ„É£", romaji: "cha" }, { kana: "„ÉÅ„É•", romaji: "chu" }, { kana: "„ÉÅ„Éß", romaji: "cho" },
            { kana: "„Éã„É£", romaji: "nya" }, { kana: "„Éã„É•", romaji: "nyu" }, { kana: "„Éã„Éß", romaji: "nyo" },
            { kana: "„Éí„É£", romaji: "hya" }, { kana: "„Éí„É•", romaji: "hyu" }, { kana: "„Éí„Éß", romaji: "hyo" },
            { kana: "„Éü„É£", romaji: "mya" }, { kana: "„Éü„É•", romaji: "myu" }, { kana: "„Éü„Éß", romaji: "myo" },
            { kana: "„É™„É£", romaji: "rya" }, { kana: "„É™„É•", romaji: "ryu" }, { kana: "„É™„Éß", romaji: "ryo" },
            { kana: "„ÇÆ„É£", romaji: "gya" }, { kana: "„ÇÆ„É•", romaji: "gyu" }, { kana: "„ÇÆ„Éß", romaji: "gyo" },
            { kana: "„Ç∏„É£", romaji: "ja" }, { kana: "„Ç∏„É•", romaji: "ju" }, { kana: "„Ç∏„Éß", romaji: "jo" },
            { kana: "„Éì„É£", romaji: "bya" }, { kana: "„Éì„É•", romaji: "byu" }, { kana: "„Éì„Éß", romaji: "byo" },
            { kana: "„Éî„É£", romaji: "pya" }, { kana: "„Éî„É•", romaji: "pyu" }, { kana: "„Éî„Éß", romaji: "pyo" }
        ];
        const extendedKatakanaChars = [
            { kana: "„Ç∑„Çß", romaji: "she" }, { kana: "„ÉÅ„Çß", romaji: "che" },
            { kana: "„ÉÑ„Ç°", romaji: "tsa" }, { kana: "„ÉÑ„Çß", romaji: "tse" }, { kana: "„ÉÑ„Ç©", romaji: "tso" },
            { kana: "„ÉÜ„Ç£", romaji: "ti" }, { kana: "„Éá„Ç£", romaji: "di" },
            { kana: "„Éï„Ç°", romaji: "fa" }, { kana: "„Éï„Ç£", romaji: "fi" }, { kana: "„Éï„Çß", romaji: "fe" }, { kana: "„Éï„Ç©", romaji: "fo" },
            { kana: "„Ç∏„Çß", romaji: "je" }, { kana: "„Éá„É•", romaji: "dyu" }, { kana: "„Ç§„Çß", romaji: "ye" },
            { kana: "„Ç¶„Ç£", romaji: "wi" }, { kana: "„Ç¶„Çß", romaji: "we" }, { kana: "„Ç¶„Ç©", romaji: "wo" },
            { kana: "„ÇØ„Ç°", romaji: "kwa" }, { kana: "„ÇØ„Ç£", romaji: "kwi" }, { kana: "„ÇØ„Çß", romaji: "kwe" }, { kana: "„ÇØ„Ç©", romaji: "kwo" },
            { kana: "„ÉÑ„Ç£", romaji: "tsi" },
            { kana: "„Éà„Ç•", romaji: "tu" }, { kana: "„Éâ„Ç•", romaji: "du" },
            { kana: "„É¥„Ç°", romaji: "va" }, { kana: "„É¥„Ç£", romaji: "vi" }, { kana: "„É¥", romaji: "vu" }, { kana: "„É¥„Çß", romaji: "ve" }, { kana: "„É¥„Ç©", romaji: "vo" },
            { kana: "„ÉÜ„É•", romaji: "tyu" }, { kana: "„Éï„É•", romaji: "fyu" }, { kana: "„É¥„É•", romaji: "vyu" }
        ];

        // --- DOM Elements ---
        const settingsScreen = document.getElementById('settingsScreen');
        const learningScreen = document.getElementById('learningScreen');
        const useHiraganaCheckbox = document.getElementById('useHiragana');
        const useKatakanaCheckbox = document.getElementById('useKatakana');
        const useExtendedKatakanaCheckbox = document.getElementById('useExtendedKatakana');
        const noSetSelectedError = document.getElementById('noSetSelectedError');
        const startButton = document.getElementById('startButton');
        
        const progressBar = document.getElementById('progressBar');
        const progressLabel = document.getElementById('progressLabel');
        const characterDisplay = document.getElementById('characterDisplay');
        const romajiInput = document.getElementById('romajiInput');
        const submitGuessButton = document.getElementById('submitGuessButton');
        const showAnswerButton = document.getElementById('showAnswerButton');
        const feedbackArea = document.getElementById('feedbackArea');
        
        const queueCountDisplay = document.getElementById('queueCountDisplay');
        const attemptCountDisplay = document.getElementById('attemptCountDisplay');
        
        const nextCharacterButton = document.getElementById('nextCharacterButton');
        const resetSessionButton = document.getElementById('resetSessionButton');
        const backToSettingsButton = document.getElementById('backToSettingsButton');
        const completionMessage = document.getElementById('completionMessage');
        const finalScore = document.getElementById('finalScore');
        const restartButton = document.getElementById('restartButton');

        // --- App State ---
        let selectedInitialChars = []; 
        let practiceQueue = []; 
        let currentKanaObject = null; 
        let timesCorrectNeeded = {}; // Stores kana characters (keys) that need more correct answers (values).
        let score = { mastered: 0, attempts: 0 };
        let totalInitialChars = 0; 
        let characterAttemptedThisTurn = false;

        // --- Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initializeSessionState() {
            totalInitialChars = selectedInitialChars.length;
            practiceQueue = shuffleArray([...selectedInitialChars]); 
            timesCorrectNeeded = {}; // Reset difficult characters tracker
            score = { mastered: 0, attempts: 0 }; // Reset score
            
            completionMessage.classList.add('hidden'); // Hide completion message
            showMainLearningUI(); // Ensure learning UI is visible
            loadNextCharacterFromQueue(); // Load the first character
        }

        function startLearningSession() {
            // Gather selected character sets
            const includeHiragana = useHiraganaCheckbox.checked;
            const includeKatakana = useKatakanaCheckbox.checked;
            const includeExtendedKatakana = useExtendedKatakanaCheckbox.checked;

            selectedInitialChars = []; // Clear previous selections
            if (includeHiragana) selectedInitialChars.push(...hiraganaChars);
            if (includeKatakana) selectedInitialChars.push(...katakanaChars);
            if (includeExtendedKatakana) selectedInitialChars.push(...extendedKatakanaChars);

            if (selectedInitialChars.length === 0) {
                noSetSelectedError.classList.remove('hidden'); // Show error if no set is selected
                return;
            }
            noSetSelectedError.classList.add('hidden'); // Hide error
            
            settingsScreen.classList.add('hidden'); // Hide settings screen
            learningScreen.classList.remove('hidden'); // Show learning screen
            initializeSessionState(); // Setup the session
        }
        
        function resetCurrentSession() {
            if (selectedInitialChars.length === 0) {
                goBackToSettings(); // If no initial set (edge case), go to settings
                return;
            }
            initializeSessionState(); // Re-initialize with the same selectedInitialChars
        }

        function loadNextCharacterFromQueue() {
            if (practiceQueue.length === 0) { // If the main queue is empty
                // Check if all selected characters are truly mastered
                const unmasteredChars = selectedInitialChars.filter(char => timesCorrectNeeded.hasOwnProperty(char.kana));
                if (unmasteredChars.length > 0) {
                    // If there are still unmastered (difficult) characters, requeue them
                    console.warn("Main queue empty, but unmastered characters remain. Requeuing them.");
                    practiceQueue = shuffleArray([...unmasteredChars]);
                } else if (totalInitialChars > 0 && score.mastered === totalInitialChars) {
                    // All characters are mastered
                    displayCompletion();
                    return;
                } else if (totalInitialChars === 0) {
                    // No characters were selected initially
                    goBackToSettings();
                    return;
                }
                // If queue is still empty after checks, it might mean completion or an issue
                if (practiceQueue.length === 0) {
                     if (totalInitialChars > 0 && score.mastered === totalInitialChars) displayCompletion();
                     else {
                        console.error("Queue empty, unable to load next character. State:", {score, totalInitialChars, timesCorrectNeededCount: Object.keys(timesCorrectNeeded).length});
                        goBackToSettings(); // Fallback
                     }
                    return;
                }
            }
            
            currentKanaObject = practiceQueue.shift(); // Get the next character

            // Update UI for the new character
            characterDisplay.textContent = currentKanaObject.kana;
            characterDisplay.classList.remove('kana-enter');
            void characterDisplay.offsetWidth; 
            characterDisplay.classList.add('kana-enter');

            romajiInput.value = '';
            romajiInput.readOnly = false;
            feedbackArea.textContent = '';
            feedbackArea.className = 'text-center text-base sm:text-lg min-h-[2.5em] mb-4 font-semibold'; // Reset feedback style
            submitGuessButton.disabled = false;
            showAnswerButton.disabled = false;
            nextCharacterButton.disabled = true;
            characterAttemptedThisTurn = false;
            
            updateStatsDisplay(); // Update scores, progress bar, etc.
            romajiInput.focus(); // Focus on input field
        }
        
        function updateStatsDisplay() {
            // Recalculate mastered count directly from source of truth
            score.mastered = selectedInitialChars.filter(char => !timesCorrectNeeded.hasOwnProperty(char.kana)).length;

            const masteryPercentage = totalInitialChars > 0 ? (score.mastered / totalInitialChars) * 100 : 0;
            progressBar.style.width = `${masteryPercentage}%`;
            progressLabel.textContent = `Mastered: ${score.mastered} / ${totalInitialChars}`;
            
            // Queue count includes the current character if one is loaded, plus the rest of the practiceQueue
            const currentQueueSize = practiceQueue.length + (currentKanaObject && !nextCharacterButton.disabled ? 0 : (currentKanaObject ? 1: 0));
             // A more direct way for queue count: what's literally in practiceQueue + the one being displayed (if any)
            let itemsEffectivelyInQueue = practiceQueue.length;
            if (currentKanaObject && !nextCharacterButton.disabled) { // If a char is displayed and we are waiting for next button
                // This means the current char is "done" for this turn, not really "in queue" in the same way.
                // However, if nextCharacterButton IS disabled, it means currentKanaObject is the active one.
            } else if (currentKanaObject) {
                 itemsEffectivelyInQueue++;
            }
            queueCountDisplay.textContent = `In Queue: ${itemsEffectivelyInQueue}`;
            attemptCountDisplay.textContent = `Attempts: ${score.attempts}`;
        }

        function processAnswer(isCorrect) {
            if (!currentKanaObject) return; // Should not happen
            const kanaKey = currentKanaObject.kana;

            if (isCorrect) {
                feedbackArea.textContent = 'Correct! üéâ';
                feedbackArea.classList.add('feedback-correct');

                if (timesCorrectNeeded.hasOwnProperty(kanaKey)) { 
                    timesCorrectNeeded[kanaKey]--; // Decrement needed correct answers
                    if (timesCorrectNeeded[kanaKey] <= 0) {
                        delete timesCorrectNeeded[kanaKey]; // Fully mastered this difficult char
                    }
                }
                // If it was never in timesCorrectNeeded, it's mastered on this try (for this cycle)
            } else { // Incorrect or Show Answer
                feedbackArea.textContent = `Incorrect. The correct answer is: ${currentKanaObject.romaji.toLowerCase()}`;
                feedbackArea.classList.add('feedback-incorrect');
                timesCorrectNeeded[kanaKey] = 2; // Mark as difficult, needs 2 correct answers
                practiceQueue.push(currentKanaObject); // Add back to the end of the queue
                shuffleArray(practiceQueue); // Re-shuffle to vary its reappearance
            }
            
            // Always recalculate score.mastered after any change to timesCorrectNeeded
            // score.mastered = selectedInitialChars.filter(char => !timesCorrectNeeded.hasOwnProperty(char.kana)).length;

            // UI updates after processing answer
            romajiInput.readOnly = true; // <-- CHANGE: Makes it un-editable but keeps it focusable
            submitGuessButton.disabled = true;
            showAnswerButton.disabled = true;
            nextCharacterButton.disabled = false;
            // We REMOVED nextCharacterButton.focus(); to keep the keyboard active
            updateStatsDisplay();
        }

        function handleGuess() {
            if (characterAttemptedThisTurn || !currentKanaObject) return;
            const guess = romajiInput.value.trim().toLowerCase();
            
            if (!guess) {
                feedbackArea.textContent = "Please enter a Romaji.";
                feedbackArea.className = 'text-center text-base sm:text-lg min-h-[2.5em] mb-4 font-semibold text-yellow-600';
                return;
            }

            characterAttemptedThisTurn = true;
            score.attempts++;
            processAnswer(guess === currentKanaObject.romaji.toLowerCase());
        }

        function handleShowAnswer() {
            if (characterAttemptedThisTurn || !currentKanaObject) return;
            
            characterAttemptedThisTurn = true;
            score.attempts++;
            // Overwrite feedback specifically for "Show Answer"
            feedbackArea.textContent = `The answer is: ${currentKanaObject.romaji.toLowerCase()}`;
            feedbackArea.className = 'text-center text-base sm:text-lg min-h-[2.5em] mb-4 font-semibold text-blue-600'; // Neutral/info color
            
            processAnswer(false); // Treat as incorrect for learning purposes (it gets re-queued)
        }
        
        function showMainLearningUI() {
            characterDisplay.classList.remove('hidden');
            learningScreen.querySelector('#romajiInput').parentElement.classList.remove('hidden');
            learningScreen.querySelector('#submitGuessButton').parentElement.classList.remove('hidden');
            learningScreen.querySelector('#queueCountDisplay').parentElement.classList.remove('hidden');
            learningScreen.querySelector('.progress-bar-container').classList.remove('hidden');
            progressLabel.classList.remove('hidden');
            nextCharacterButton.classList.remove('hidden');
            resetSessionButton.classList.remove('hidden');
            completionMessage.classList.add('hidden');
        }

        function hideMainLearningUI() {
            characterDisplay.classList.add('hidden');
            learningScreen.querySelector('#romajiInput').parentElement.classList.add('hidden');
            learningScreen.querySelector('#submitGuessButton').parentElement.classList.add('hidden');
            learningScreen.querySelector('#queueCountDisplay').parentElement.classList.add('hidden');
            learningScreen.querySelector('.progress-bar-container').classList.add('hidden');
            progressLabel.classList.add('hidden');
            nextCharacterButton.classList.add('hidden');
            resetSessionButton.classList.add('hidden');
        }

        function displayCompletion() {
            hideMainLearningUI();
            completionMessage.classList.remove('hidden');
            // Ensure final mastered count is accurate before displaying
            score.mastered = selectedInitialChars.filter(char => !timesCorrectNeeded.hasOwnProperty(char.kana)).length;
            finalScore.textContent = `Mastered: ${score.mastered} / ${totalInitialChars} in ${score.attempts} attempts.`;
        }
        
        function goBackToSettings() {
            learningScreen.classList.add('hidden');
            completionMessage.classList.add('hidden');
            settingsScreen.classList.remove('hidden');
            noSetSelectedError.classList.add('hidden');
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', startLearningSession);
        resetSessionButton.addEventListener('click', resetCurrentSession);
        submitGuessButton.addEventListener('click', handleGuess);
        romajiInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                // Stop the default browser action for the Enter key
                event.preventDefault(); 

                // Check which action to perform based on which button is enabled
                if (!submitGuessButton.disabled) {
                    // If we are waiting for a guess, handle the guess.
                    handleGuess();
                } else if (!nextCharacterButton.disabled) {
                    // If we are waiting to move on, load the next character.
                    currentKanaObject = null; // This mimics the button click
                    loadNextCharacterFromQueue();
                }
            }
        });    
        showAnswerButton.addEventListener('click', handleShowAnswer);
        nextCharacterButton.addEventListener('click', () => {
            currentKanaObject = null; // Clear current object before loading next
            loadNextCharacterFromQueue();
        });
        backToSettingsButton.addEventListener('click', goBackToSettings);
        restartButton.addEventListener('click', () => {
            goBackToSettings(); 
        });

        // Initial focus on settings screen
        if (useHiraganaCheckbox) useHiraganaCheckbox.focus();

    </script>
</body>
</html>
